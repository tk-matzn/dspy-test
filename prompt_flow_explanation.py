#!/usr/bin/env python3
"""
DSPyå†…éƒ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæµã‚Œã‚’ç°¡æ½”ã«è¡¨ç¤º
"""

import os
import dspy
from dotenv import load_dotenv

load_dotenv()

# Azure OpenAIè¨­å®š
azure_key = os.getenv("AZURE_OPENAI_API_KEY")
azure_endpoint = os.getenv("AZURE_OPENAI_ENDPOINT")

if azure_key and azure_endpoint:
    dspy.configure(lm=dspy.LM(
        model=f"azure/gpt-35-turbo",
        api_key=azure_key,
        api_base=azure_endpoint,
        api_version="2024-02-15-preview",
        max_tokens=200
    ))

# ========== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæµã‚Œã®è©³ç´° ==========
print("=" * 70)
print("DSPy ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…éƒ¨ãƒ•ãƒ­ãƒ¼")
print("=" * 70)

print("\nğŸ“Š DSPyã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œãƒ•ãƒ­ãƒ¼:\n")

flow_diagram = """
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰                                          â”‚
â”‚    predict = dspy.Predict("question -> answer")             â”‚
â”‚    result = predict(question="Pythonã¨ã¯ï¼Ÿ")              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ã‚·ã‚°ãƒãƒãƒ£è§£æ                                          â”‚
â”‚    â€¢ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: question                             â”‚
â”‚    â€¢ å‡ºåŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: answer                               â”‚
â”‚    â€¢ è‡ªå‹•çš„ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰                                          â”‚
â”‚                                                             â”‚
â”‚  [ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ]                                     â”‚
â”‚  You are an expert at answering questions in a              â”‚
â”‚  clear, concise, and informative manner...                 â”‚
â”‚                                                             â”‚
â”‚  [ã‚¿ã‚¹ã‚¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ]                                       â”‚
â”‚  Follow the following format.                              â”‚
â”‚                                                             â”‚
â”‚  Question: ${question}                                     â”‚
â”‚  Answer: ${answer}                                         â”‚
â”‚                                                             â”‚
â”‚  [å…¥åŠ›ãƒ‡ãƒ¼ã‚¿]                                             â”‚
â”‚  Question: Pythonã¨ã¯ï¼Ÿ                                   â”‚
â”‚  Answer:                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. LM APIå‘¼ã³å‡ºã—                                          â”‚
â”‚    â€¢ Azure OpenAI APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡                     â”‚
â”‚    â€¢ å®Œå…¨ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                    â”‚
â”‚    â€¢ Temperature, Max Tokensç­‰ã®è¨­å®šã‚’é©ç”¨               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. LLMå‡¦ç†                                                  â”‚
â”‚    LLMå†…éƒ¨ã§:                                             â”‚
â”‚    â€¢ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒ³åŒ–                              â”‚
â”‚    â€¢ ãƒˆãƒ¼ã‚¯ãƒ³ã‚·ãƒ¼ã‚±ãƒ³ã‚¹äºˆæ¸¬                              â”‚
â”‚    â€¢ ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å¿œç­”å—ä¿¡ãƒ»è§£æ                                          â”‚
â”‚    Answer: Python ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã®                    â”‚
â”‚             ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™...                    â”‚
â”‚    â†“                                                        â”‚
â”‚    â€¢ LLMã‹ã‚‰ã®å®Œå…¨ãªå¿œç­”ã‚’å—ä¿¡                           â”‚
â”‚    â€¢ å‡ºåŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆanswerï¼‰ã‚’æŠ½å‡º                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. çµæœè¿”å´                                                 â”‚
â”‚    Prediction(answer="Python ã¯...")                       â”‚
â”‚    â€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¿”å´                      â”‚
â”‚    â€¢ æ§‹é€ åŒ–ã•ã‚ŒãŸå½¢å¼                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
"""

print(flow_diagram)

# ========== è©³ç´°ãªè¨­å®šæƒ…å ± ==========
print("\nğŸ“‹ DSPyè¨­å®šã®è©³ç´°:\n")

lm = dspy.settings.lm
print(f"LMã‚¯ãƒ©ã‚¹: {lm.__class__.__name__}")
print(f"ãƒ¢ãƒ‡ãƒ«: {lm.model}")
if hasattr(lm, 'max_tokens'):
    print(f"Max Tokens: {lm.max_tokens}")

# ========== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¾‹ ==========
print("\n" + "=" * 70)
print("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å®Ÿä¾‹")
print("=" * 70)

# Predictã‚’ä½œæˆ
predict = dspy.Predict("topic -> explanation")

# ã‚·ã‚°ãƒãƒãƒ£ã‚’ç¢ºèª
sig = predict.signature
print(f"\nã‚·ã‚°ãƒãƒãƒ£: {sig}")
print(f"å…¥åŠ›: {list(sig.input_fields.keys())}")
print(f"å‡ºåŠ›: {list(sig.output_fields.keys())}")

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆå®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
print("\nâœ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæº–å‚™å®Œäº†")
print("  å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã§ã¯ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒä½¿ç”¨ã•ã‚Œã¾ã™")

# ========== è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®æµã‚Œ ==========
print("\n" + "=" * 70)
print("è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæµã‚Œ")
print("=" * 70)

multi_step_flow = """
ä¾‹: 3ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…¥åŠ›: "AIã«ã¤ã„ã¦èª¬æ˜ã—ã¦"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆæŠ½å‡º         â”‚
â”‚  Prompt: "Text -> KeyPoints"     â”‚
â”‚  â†“ APIå‘¼ã³å‡ºã—1å›ç›® â†“           â”‚
â”‚  Output: "1. ML 2. NLP ..."      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: è©³ç´°èª¬æ˜ä½œæˆ            â”‚
â”‚  Prompt: "KeyPoints -> Details"  â”‚
â”‚  â†“ APIå‘¼ã³å‡ºã—2å›ç›® â†“           â”‚
â”‚  Output: "ML ã¯..."              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: è¦ç´„ä½œæˆ                â”‚
â”‚  Prompt: "Details -> Summary"    â”‚
â”‚  â†“ APIå‘¼ã³å‡ºã—3å›ç›® â†“           â”‚
â”‚  Output: "AIã¯..."               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ€çµ‚çµæœ: æ§‹é€ åŒ–ã•ã‚ŒãŸå›ç­”      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ:
  â€¢ å„ã‚¹ãƒ†ãƒƒãƒ—ã¯ç‹¬ç«‹ã—ãŸAPIå‘¼ã³å‡ºã—
  â€¢ å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ãŒæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ã«
  â€¢ DSPyãŒã“ã®æµã‚Œã‚’è‡ªå‹•ç®¡ç†
"""

print(multi_step_flow)

# ========== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã®æµã‚Œ ==========
print("\n" + "=" * 70)
print("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã®æ¦‚å¿µ")
print("=" * 70)

optimization_flow = """
ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ãƒ—ãƒ­ã‚»ã‚¹ã€‘

åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:
  "question -> answer"

           â†“ BootstrapFewShotç­‰ã§æœ€é©åŒ–
           
æ”¹å–„ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:
  "Instruction: ã‚ãªãŸã¯å°‚é–€å®¶ã§ã™..."
  
  Example 1:
    Question: ...
    Answer: ...
  
  Example 2:
    Question: ...
    Answer: ...
  
  Question: ${input_question}
  Answer: """

print(optimization_flow)

print("\n" + "=" * 70)
print("âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæµã‚Œã®èª¬æ˜ãŒå®Œäº†ã—ã¾ã—ãŸ")
print("=" * 70)
